<section class="dashboard-section">

  <div class="balance-card" [ngClass]="getStatusClass(balanceStatus())">
    <p>Solde actuel (filtr√©) :</p>
    <p class="balance-amount">{{ totalBalance() | number:'1.2-2' }} ‚Ç¨</p>
    <p class="status-message" *ngIf="balanceStatus() === 'rouge'">
      Attention : Vous √™tes dans le rouge ce mois-ci !
    </p>
  </div>
  
  <div class="dashboard-grid">
    <div class="stats-control-zone">
        <div class="top-items-container">
            <div class="top-item-card card">
                <h3>üî• Top 3 D√©penses</h3>
                <div *ngIf="top3Expenses().length === 0" class="no-data">Aucune d√©pense.</div>
                <ul>
                    <li *ngFor="let expense of top3Expenses()">
                        <strong>{{ expense.category }}</strong>
                        <span *ngIf="expense.subcategory" class="subcategory-badge">{{ expense.subcategory }}</span>
                        <span class="amount">{{ expense.totalAmount | number:'1.2-2' }} ‚Ç¨</span>
                    </li>
                </ul>
            </div>

            <div class="top-item-card card">
                <h3>üí∞ Top 3 Revenus</h3>
                <div *ngIf="top3Revenues().length === 0" class="no-data">Aucun revenu.</div>
                <ul>
                    <li *ngFor="let revenue of top3Revenues()">
                        <strong>{{ revenue.category }}</strong>
                        <span *ngIf="revenue.subcategory" class="subcategory-badge">{{ revenue.subcategory }}</span>
                        <span class="amount">{{ revenue.totalAmount | number:'1.2-2' }} ‚Ç¨</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="add-button-container double-buttons">
            <button class="add-transaction-button" (click)="openAddModal()">+ Ajouter</button>
            <button class="manage-category-button-in-grid" (click)="openCategoryModal()">‚öôÔ∏è Cat√©gories</button>
        </div>
    </div>
    
    <div class="filters card full-height-card">
      <h3>üîé Filtres</h3>
      <div class="filter-group">
        <label for="month-filter">Filtrer par Mois :</label>
        <input id="month-filter" type="month" 
               [ngModel]="selectedMonth()" 
               (ngModelChange)="updateMonth($event)">
      </div>
      
      <div class="filter-group">
        <label for="category-filter">Filtrer par Cat√©gorie :</label>
        <select id="category-filter" 
                [ngModel]="selectedCategory()" 
                (ngModelChange)="updateCategory($event)">
          <option value="">Toutes les cat√©gories</option>
          <option *ngFor="let cat of allCategories()" [value]="cat">{{ cat }}</option>
        </select>
      </div>
      
      <button class="export-button" (click)="exportData()">Exporter (JSON)</button>
      <div class="import-container">
          <input type="file" #fileInput hidden (change)="handleFileInput($event)" accept=".json">
          <button class="import-button" (click)="fileInput.click()">Importer (JSON)</button>
      </div>
    </div>
  </div>

  <ng-container *ngIf="filteredTransactions() as transactions">
      
      <div *ngIf="transactions.length === 0" class="data-warning card">
        <h3>‚ö† Aucune donn√©e charg√©e</h3>
        <p>Utilisez le bouton **Importer** ou ajoutez des transactions.</p>
      </div>
      
      <div *ngIf="transactions.length > 0">
        <div class="chart-container card" style="margin-bottom: 20px;">
            <h3>üí∏ Flux de Tr√©sorerie (Sankey)</h3>
            <app-cashflow-sankey-chart [transactions]="transactions"></app-cashflow-sankey-chart>
        </div>

        <div class="chart-container card"> 
            <h3>üìà √âvolution du Solde</h3>
            <button (click)="toggleChart()" class="chart-toggle-button">
                {{ showBalanceChart() ? 'Masquer' : 'Afficher' }} le Graphique
            </button>

            <div *ngIf="showBalanceChart()" class="graph-area">
                <div *ngIf="lineChartData().labels!.length > 0">
                    <canvas baseChart
                        [data]="lineChartData()"
                        [options]="lineChartOptions"
                        [type]="lineChartType">
                    </canvas>
                </div>
            </div>
        </div>
      </div>
      
      <h3>üìú Liste des Transactions ({{ transactions.length }} √©l√©ments)</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="sortable-header" (click)="setSort('date')">
                Date <span *ngIf="currentSortColumn() === 'date'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('category')">
                Cat√©gorie <span *ngIf="currentSortColumn() === 'category'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('subcategory')">
                Sous-cat. <span *ngIf="currentSortColumn() === 'subcategory'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('type')">
                Type <span *ngIf="currentSortColumn() === 'type'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('method')">
                Moyen <span *ngIf="currentSortColumn() === 'method'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('amount')">
                Montant (‚Ç¨) <span *ngIf="currentSortColumn() === 'amount'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th class="sortable-header" (click)="setSort('description')">
                Description <span *ngIf="currentSortColumn() === 'description'">{{ currentSortDirection() === 'asc' ? '‚Üë' : '‚Üì' }}</span>
              </th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of transactions" 
                [ngClass]="{'row-revenu': t.type === 'Revenu', 'row-depense': t.type === 'D√©pense'}">
              <td>{{ formatDate(t.date) }}</td>
              <td>{{ t.category }}</td>
              <td>
                <span *ngIf="t.subcategory" class="subcategory-tag">{{ t.subcategory }}</span>
                <span *ngIf="!t.subcategory" class="subcategory-empty">‚Äî</span>
              </td>
              <td>{{ t.type }}</td>
              <td>{{ t.method }}</td>
              <td class="amount-cell">{{ t.amount | number:'1.2-2' }}</td>
              <td>{{ t.description }}</td>
              <td class="action-buttons">
                  <button class="edit-button" (click)="onEdit(t)">Modifier</button> 
                  <button class="delete-button" (click)="onDelete(t.id, t.description || '')">Supprimer</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

  </ng-container>

  <footer class="app-footer">
    <div class="footer-content">
      <p>&copy; 2026 Gestionnaire de Budget</p>
    </div>
  </footer>

</section>