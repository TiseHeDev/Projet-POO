<section class="dashboard-section">
  <h2>ðŸ“Š AperÃ§u du Budget</h2>

  <div class="balance-card" [ngClass]="getStatusClass(balanceStatus$ | async)">
    <p>Solde actuel (filtrÃ©) :</p>
    <p class="balance-amount">{{ totalBalance$ | async | number:'1.2-2' }} â‚¬</p>
    <p class="status-message" *ngIf="(balanceStatus$ | async) === 'rouge'">
      Attention : Vous Ãªtes dans le rouge ce mois-ci !
    </p>
  </div>
  
  <div class="dashboard-grid">
    
    <div class="top-expenses card">
      <h3>ðŸ”¥ Top 3 DÃ©penses</h3>
      <div *ngIf="(top3Expenses$ | async)?.length === 0" class="no-data">
        Aucune dÃ©pense enregistrÃ©e (ou filtrÃ©e).
      </div>
      <ul>
        <li *ngFor="let expense of top3Expenses$ | async">
          <strong>{{ expense.category }}:</strong> 
          <span>{{ expense.totalAmount | number:'1.2-2' }} â‚¬</span>
        </li>
      </ul>
    </div>
    
    <div class="filters card">
      <h3>ðŸ”Ž Filtres</h3>
      <div class="filter-group">
        <label for="month-filter">Filtrer par Mois :</label>
        <input id="month-filter" type="month" [(ngModel)]="selectedMonth" (ngModelChange)="applyFilters()">
      </div>
      
      <div class="filter-group">
        <label for="category-filter">Filtrer par CatÃ©gorie :</label>
        <select id="category-filter" [(ngModel)]="selectedCategory" (ngModelChange)="applyFilters()">
          <option value="">Toutes les catÃ©gories</option>
          <option *ngFor="let cat of allCategories" [value]="cat">{{ cat }}</option>
        </select>
      </div>
    </div>
  </div>

  <div class="chart-container card">
    <h3>ðŸ“ˆ Ã‰volution du Solde</h3>
    
    <button (click)="toggleChart()" class="chart-toggle-button">
        {{ showBalanceChart ? 'Masquer le Graphique' : 'Afficher le Graphique' }}
    </button>

    <div *ngIf="showBalanceChart" class="graph-area">
        <ng-container *ngIf="lineChartData as chartData">
            
            <div *ngIf="chartData.labels!.length > 0">
                <canvas baseChart
                    [data]="chartData"
                    [options]="lineChartOptions"
                    [type]="lineChartType">
                </canvas>
            </div>
            
            <div *ngIf="chartData.labels!.length === 0" class="no-data">
                Ajoutez des transactions pour afficher l'Ã©volution du solde.
            </div>
        </ng-container>
    </div>
  </div>


  <h3>ðŸ“œ Liste des Transactions ({{ (filteredTransactions$ | async)?.length || 0 }} Ã©lÃ©ments)</h3>
  <table>
    <thead>
      <tr>
        <th class="sortable-header" (click)="setSort('date')">
          Date
          <span *ngIf="currentSortColumn === 'date'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th class="sortable-header" (click)="setSort('category')">
          CatÃ©gorie
          <span *ngIf="currentSortColumn === 'category'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th class="sortable-header" (click)="setSort('type')">
          Type
          <span *ngIf="currentSortColumn === 'type'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th class="sortable-header" (click)="setSort('method')">
          Moyen
          <span *ngIf="currentSortColumn === 'method'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th class="sortable-header" (click)="setSort('amount')">
          Montant (â‚¬)
          <span *ngIf="currentSortColumn === 'amount'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th class="sortable-header" (click)="setSort('description')">
          Description
          <span *ngIf="currentSortColumn === 'description'">
            {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
          </span>
        </th>
        
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let t of filteredTransactions$ | async" 
          [ngClass]="{'row-revenu': t.type === 'Revenu', 'row-depense': t.type === 'DÃ©pense'}">
        <td>{{ formatDate(t.date) }}</td>
        <td>{{ t.category }}</td>
        <td>{{ t.type }}</td>
        <td>{{ t.method }}</td>
        <td class="amount-cell">{{ t.amount | number:'1.2-2' }}</td>
        <td>{{ t.description }}</td>
        <td class="action-buttons">
            <button class="edit-button" (click)="onEdit(t)">Modifier</button> 
            <button class="delete-button" (click)="onDelete(t.id, t.description || 'cette transaction')">Supprimer</button>
        </td>
      </tr>
      <tr *ngIf="(filteredTransactions$ | async)?.length === 0">
          <td colspan="7" class="no-data-row">Aucune transaction trouvÃ©e pour les filtres.</td>
      </tr>
    </tbody>
  </table>
</section>