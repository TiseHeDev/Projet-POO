<section class="dashboard-section">

  <div class="balance-card" [ngClass]="getStatusClass(balanceStatus$ | async)">
    <p>Solde actuel (filtr√©) :</p>
    <p class="balance-amount">{{ totalBalance$ | async | number:'1.2-2' }} ‚Ç¨</p>
    <p class="status-message" *ngIf="(balanceStatus$ | async) === 'rouge'">
      Attention : Vous √™tes dans le rouge ce mois-ci !
    </p>
  </div>
  
  <div class="dashboard-grid">
    
    <div class="stats-control-zone">
        
        <div class="top-items-container">
            
            <div class="top-item-card card">
                <h3>üî• Top 3 D√©penses</h3>
                <ng-container *ngIf="top3Expenses$ | async as topExpenses">
                    <div *ngIf="topExpenses.length === 0" class="no-data">
                        Aucune d√©pense enregistr√©e.
                    </div>
                    <ul>
                        <li *ngFor="let expense of topExpenses">
                            <strong>{{ expense.category }}:</strong> 
                            <span>{{ expense.totalAmount | number:'1.2-2' }} ‚Ç¨</span>
                        </li>
                    </ul>
                </ng-container>
            </div>

            <div class="top-item-card card">
                <h3>üí∞ Top 3 Revenus</h3>
                <ng-container *ngIf="top3Revenues$ | async as topRevenues">
                    <div *ngIf="topRevenues.length === 0" class="no-data">
                        Aucun revenu enregistr√©.
                    </div>
                    <ul>
                        <li *ngFor="let revenue of topRevenues">
                            <strong>{{ revenue.category }}:</strong> 
                            <span>{{ revenue.totalAmount | number:'1.2-2' }} ‚Ç¨</span>
                        </li>
                    </ul>
                </ng-container>
            </div>

        </div>

        <div class="add-button-container double-buttons">
            <button class="add-transaction-button" (click)="openAddModal()">
                + Ajouter
            </button>
            <button class="manage-category-button-in-grid" (click)="openCategoryModal()">
                ‚öôÔ∏è Cat√©gories
            </button>
        </div>

    </div>
    
    <div class="filters card full-height-card">
      <h3>üîé Filtres</h3>
      <div class="filter-group">
        <label for="month-filter">Filtrer par Mois :</label>
        <input id="month-filter" type="month" [(ngModel)]="selectedMonth" (ngModelChange)="applyFilters()">
      </div>
      
      <div class="filter-group">
        <label for="category-filter">Filtrer par Cat√©gorie :</label>
        <select id="category-filter" [(ngModel)]="selectedCategory" (ngModelChange)="applyFilters()">
          <option value="">Toutes les cat√©gories</option>
          <option *ngFor="let cat of allCategories" [value]="cat">{{ cat }}</option>
        </select>
      </div>
      
      <button class="export-button" (click)="exportData()">Exporter les donn√©es (JSON)</button>
      
      <div class="import-container">
          <input type="file" #fileInput hidden (change)="handleFileInput($event)" accept=".json">
          <button class="import-button" (click)="fileInput.click()">Importer les donn√©es (JSON)</button>
      </div>
      
    </div>
  </div>

  <ng-container *ngIf="filteredTransactions$ | async as transactions">
      
      <div *ngIf="transactions.length === 0" class="data-warning card">
        <h3>‚ö† Aucune donn√©e charg√©e</h3>
        <p>Vos transactions ne sont pas sauvegard√©es localement. Veuillez utiliser le bouton **Importer les donn√©es** pour charger votre fichier JSON, ou commencer √† ajouter de nouvelles transactions.</p>
      </div>
      
      <div *ngIf="transactions.length > 0">
        
        <div class="chart-container card" style="margin-bottom: 20px;">
            <h3>üåä Flux de Tr√©sorerie</h3>
            <app-cashflow-sankey-chart [transactions]="transactions"></app-cashflow-sankey-chart>
        </div>

        <div class="chart-container card"> 
            <h3>üìà √âvolution du Solde</h3>
            
            <button (click)="toggleChart()" class="chart-toggle-button">
                {{ showBalanceChart ? 'Masquer le Graphique' : 'Afficher le Graphique' }}
            </button>

            <div *ngIf="showBalanceChart" class="graph-area">
                <ng-container *ngIf="lineChartData as chartData">
                    <div *ngIf="chartData.labels!.length > 0">
                        <canvas baseChart
                            [data]="chartData"
                            [options]="lineChartOptions"
                            [type]="lineChartType">
                        </canvas>
                    </div>
                    
                    <div *ngIf="chartData.labels!.length === 0" class="no-data">
                        Pas assez de donn√©es pour afficher le graphique.
                    </div>
                </ng-container>
            </div>
        </div>

      </div>
      
      <h3>üìú Liste des Transactions ({{ transactions.length }} √©l√©ments)</h3>
      <table>
        <thead>
          <tr>
            <th class="sortable-header" (click)="setSort('date')">
              Date
              <span *ngIf="currentSortColumn === 'date'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th class="sortable-header" (click)="setSort('category')">
              Cat√©gorie
              <span *ngIf="currentSortColumn === 'category'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th class="sortable-header" (click)="setSort('type')">
              Type
              <span *ngIf="currentSortColumn === 'type'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th class="sortable-header" (click)="setSort('method')">
              Moyen
              <span *ngIf="currentSortColumn === 'method'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th class="sortable-header" (click)="setSort('amount')">
              Montant (‚Ç¨)
              <span *ngIf="currentSortColumn === 'amount'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th class="sortable-header" (click)="setSort('description')">
              Description
              <span *ngIf="currentSortColumn === 'description'">
                {{ currentSortDirection === 'asc' ? ' &uarr;' : ' &darr;' }}
              </span>
            </th>
            
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of transactions" 
              [ngClass]="{'row-revenu': t.type === 'Revenu', 'row-depense': t.type === 'D√©pense'}">
            <td>{{ formatDate(t.date) }}</td>
            <td>{{ t.category }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.method }}</td>
            <td class="amount-cell">{{ t.amount | number:'1.2-2' }}</td>
            <td>{{ t.description }}</td>
            <td class="action-buttons">
                <button class="edit-button" (click)="onEdit(t)">Modifier</button> 
                <button class="delete-button" (click)="onDelete(t.id, t.description || 'cette transaction')">Supprimer</button>
            </td>
          </tr>
          <tr *ngIf="transactions.length === 0">
              <td colspan="7" class="no-data-row">Aucune transaction charg√©e.</td>
          </tr>
        </tbody>
      </table>

  </ng-container>

  <footer class="app-footer">
    <div class="footer-content">
      <p>&copy; 2026 Sandri Matt√©o | Marquis-Favre Anton</p>
      <div class="footer-links">


        <a href="#">Contact</a>
      </div>
      <p class="footer-note">Fait avec <span style="color: #e25555;">&hearts;</span></p>
    </div>
  </footer>

</section>